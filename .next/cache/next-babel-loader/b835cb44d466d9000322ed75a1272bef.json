{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nvar __jsx = React.createElement;\nimport Head from 'next/head';\nimport Link from 'next/link';\nimport AV from 'leancloud-storage';\nimport dynamic from 'next/dynamic';\nimport React, { useState, useEffect } from 'react';\nimport { useRouter } from 'next/router';\nimport marked from 'marked';\nimport hljs from 'highlight.js';\nimport { BackTop, message } from 'antd';\nimport dayjs from 'dayjs';\nimport ReactScroll from 'react-scroll';\nimport styles from './index.module.scss';\nimport Layout from 'src/components/www/Layout';\nimport Comments from 'src/components/www/Comments';\nimport CategoryList from 'src/components/www/CategoryList';\nimport Ad from 'src/components/www/Ad';\nimport UserInfo from 'src/components/www/UserInfo';\nimport { getArticleById, updateArticle } from 'src/service/article';\nimport { createCollect, deleteCollect, countCollect, getMyCollect } from 'src/service/collect';\nimport { createLike, deleteLike, countLike, getMyLike } from 'src/service/likes';\nimport { countComments } from 'src/service/comment';\n\nrequire('dayjs/locale/zh-cn');\n\ndayjs.locale('zh-cn');\n\nvar relativeTime = require('dayjs/plugin/relativeTime');\n\ndayjs.extend(relativeTime);\nvar nav = [];\nvar renderer = new marked.Renderer();\n\nrenderer.heading = function heading(text, level, raw, slugger) {\n  nav.push({\n    text: text,\n    level: level,\n    raw: raw,\n    slugger: slugger,\n    id: this.options.headerPrefix + slugger.slug(raw) + '-1'\n  });\n\n  if (this.options.headerIds) {\n    return '<h' + level + ' id=\"' + this.options.headerPrefix + slugger.slug(raw) + '\">' + text + '</h' + level + '>\\n';\n  } // ignore IDs\n\n\n  return '<h' + level + '>' + text + '</h' + level + '>\\n';\n};\n\nmarked.setOptions({\n  renderer: renderer,\n  highlight: function highlight(code, language) {\n    var hljs = require('highlight.js');\n\n    var validLanguage = hljs.getLanguage(language) ? language : 'plaintext';\n    return hljs.highlight(validLanguage, code).value;\n  },\n  pedantic: false,\n  gfm: true,\n  breaks: false,\n  sanitize: false,\n  smartLists: true,\n  smartypants: false,\n  xhtml: false\n});\n\nfunction MyComponent() {\n  var router = useRouter();\n  var aid = router.query.id;\n\n  var _useState = useState(null),\n      articleObj = _useState[0],\n      setarticleObj = _useState[1];\n\n  var _useState2 = useState(null),\n      articleObjJSON = _useState2[0],\n      setarticleObjJSON = _useState2[1];\n\n  var _useState3 = useState(null),\n      author = _useState3[0],\n      setauthor = _useState3[1];\n\n  var _useState4 = useState(null),\n      profile = _useState4[0],\n      setprofile = _useState4[1];\n\n  var _useState5 = useState(null),\n      userinfo = _useState5[0],\n      setuserinfo = _useState5[1];\n\n  var _useState6 = useState(null),\n      html = _useState6[0],\n      sethtml = _useState6[1];\n\n  var _useState7 = useState(0),\n      views = _useState7[0],\n      setviews = _useState7[1];\n\n  var _useState8 = useState(0),\n      num_collects = _useState8[0],\n      setnum_collects = _useState8[1];\n\n  var _useState9 = useState(null),\n      myCollect = _useState9[0],\n      setmyCollect = _useState9[1];\n\n  var _useState10 = useState(0),\n      num_comments = _useState10[0],\n      setnum_comments = _useState10[1];\n\n  var _useState11 = useState(0),\n      num_likes = _useState11[0],\n      setnum_likes = _useState11[1];\n\n  var _useState12 = useState(null),\n      myLike = _useState12[0],\n      setmyLike = _useState12[1];\n\n  useEffect(function () {\n    function fetchData() {\n      var res, numCollect, numLike, numComments;\n      return _regeneratorRuntime.async(function fetchData$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!aid) {\n                _context.next = 33;\n                break;\n              }\n\n              _context.next = 3;\n              return _regeneratorRuntime.awrap(getArticleById({\n                id: aid\n              }));\n\n            case 3:\n              res = _context.sent;\n              setarticleObj(res);\n              setarticleObjJSON(res.toJSON());\n              setauthor(res.attributes.author);\n              sethtml(marked(res.attributes.articleVal)); // 访问数+1\n\n              _context.next = 10;\n              return _regeneratorRuntime.awrap(updateArticle({\n                articleItem: res,\n                params: {\n                  views: 1\n                }\n              }));\n\n            case 10:\n              setviews(res.attributes.views); // 收藏数量\n\n              _context.t0 = setnum_collects;\n              _context.next = 14;\n              return _regeneratorRuntime.awrap(countCollect({\n                article: res\n              }));\n\n            case 14:\n              _context.t1 = _context.sent;\n              (0, _context.t0)(_context.t1);\n              _context.next = 18;\n              return _regeneratorRuntime.awrap(getMyCollect({\n                article: res\n              }));\n\n            case 18:\n              numCollect = _context.sent;\n              setmyCollect(numCollect); // 收藏数量\n\n              _context.t2 = setnum_likes;\n              _context.next = 23;\n              return _regeneratorRuntime.awrap(countLike({\n                article: res\n              }));\n\n            case 23:\n              _context.t3 = _context.sent;\n              (0, _context.t2)(_context.t3);\n              _context.next = 27;\n              return _regeneratorRuntime.awrap(getMyLike({\n                article: res\n              }));\n\n            case 27:\n              numLike = _context.sent;\n              setmyLike(numLike); // 评论数量\n\n              _context.next = 31;\n              return _regeneratorRuntime.awrap(countComments({\n                article: res\n              }));\n\n            case 31:\n              numComments = _context.sent;\n              setnum_comments(numComments);\n\n            case 33:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    }\n\n    fetchData();\n  }, [router]);\n\n  var handleCollect = function handleCollect() {\n    return _regeneratorRuntime.async(function handleCollect$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            _context2.next = 2;\n            return _regeneratorRuntime.awrap(handleAction({\n              actionName: '收藏',\n              actionName_en: 'collects',\n              myItem: myCollect,\n              createFunc: createCollect,\n              delectMyItemFunc: deleteCollect,\n              getMyItemFunc: getMyCollect,\n              countAllFuc: countCollect,\n              setMyItemFunc: setmyCollect,\n              setNumberFunc: setnum_collects,\n              article: articleObj\n            }));\n\n          case 2:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  };\n\n  var handleLike = function handleLike() {\n    return _regeneratorRuntime.async(function handleLike$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            _context3.next = 2;\n            return _regeneratorRuntime.awrap(handleAction({\n              actionName: '点赞',\n              actionName_en: 'likes',\n              myItem: myLike,\n              createFunc: createLike,\n              delectMyItemFunc: deleteLike,\n              getMyItemFunc: getMyLike,\n              countAllFuc: countLike,\n              setMyItemFunc: setmyLike,\n              setNumberFunc: setnum_likes,\n              article: articleObj\n            }));\n\n          case 2:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  };\n\n  var handleAction = function handleAction(_ref) {\n    var actionName, actionName_en, myItem, createFunc, delectMyItemFunc, getMyItemFunc, countAllFuc, setMyItemFunc, setNumberFunc, article;\n    return _regeneratorRuntime.async(function handleAction$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            actionName = _ref.actionName, actionName_en = _ref.actionName_en, myItem = _ref.myItem, createFunc = _ref.createFunc, delectMyItemFunc = _ref.delectMyItemFunc, getMyItemFunc = _ref.getMyItemFunc, countAllFuc = _ref.countAllFuc, setMyItemFunc = _ref.setMyItemFunc, setNumberFunc = _ref.setNumberFunc, article = _ref.article;\n\n            if (AV.User.current()) {\n              _context4.next = 4;\n              break;\n            }\n\n            message.error('请先登录');\n            return _context4.abrupt(\"return\");\n\n          case 4:\n            if (!myItem) {\n              _context4.next = 21;\n              break;\n            }\n\n            _context4.next = 7;\n            return _regeneratorRuntime.awrap(delectMyItemFunc({\n              item: myItem\n            }));\n\n          case 7:\n            _context4.t0 = setNumberFunc;\n            _context4.next = 10;\n            return _regeneratorRuntime.awrap(countAllFuc({\n              article: article\n            }));\n\n          case 10:\n            _context4.t1 = _context4.sent;\n            (0, _context4.t0)(_context4.t1);\n            _context4.t2 = setMyItemFunc;\n            _context4.next = 15;\n            return _regeneratorRuntime.awrap(getMyItemFunc({\n              article: article\n            }));\n\n          case 15:\n            _context4.t3 = _context4.sent;\n            (0, _context4.t2)(_context4.t3);\n            message.success(\"\\u53D6\\u6D88\".concat(actionName)); // 更新article 相关数量字段\n\n            updateArticle({\n              articleItem: article,\n              params: _defineProperty({}, \"\".concat(actionName_en), -1)\n            });\n            _context4.next = 35;\n            break;\n\n          case 21:\n            _context4.next = 23;\n            return _regeneratorRuntime.awrap(createFunc({\n              article: article\n            }));\n\n          case 23:\n            _context4.t4 = setNumberFunc;\n            _context4.next = 26;\n            return _regeneratorRuntime.awrap(countAllFuc({\n              article: article\n            }));\n\n          case 26:\n            _context4.t5 = _context4.sent;\n            (0, _context4.t4)(_context4.t5);\n            _context4.t6 = setMyItemFunc;\n            _context4.next = 31;\n            return _regeneratorRuntime.awrap(getMyItemFunc({\n              article: article\n            }));\n\n          case 31:\n            _context4.t7 = _context4.sent;\n            (0, _context4.t6)(_context4.t7);\n            message.success(\"\".concat(actionName, \"\\u6210\\u529F\")); // 更新article 相关数量字段\n\n            updateArticle({\n              articleItem: article,\n              params: _defineProperty({}, \"\".concat(actionName_en), 1)\n            });\n\n          case 35:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  };\n\n  return __jsx(Layout, {\n    onChange: function onChange(params) {\n      setprofile(params.profile);\n      setuserinfo(params.userinfo);\n    }\n  }, __jsx(BackTop, null), articleObj && articleObjJSON && __jsx(\"div\", {\n    className: styles.container\n  }, __jsx(\"div\", {\n    className: styles.left\n  }, __jsx(\"div\", {\n    className: styles.left_content\n  }, __jsx(UserInfo, {\n    userinfo: author,\n    time: dayjs(articleObj.createdAt).format('YYYY/MM/DD'),\n    views: views\n  }), __jsx(\"p\", {\n    className: styles.title\n  }, articleObjJSON.title), __jsx(\"article\", {\n    className: \"markdown-body\",\n    dangerouslySetInnerHTML: {\n      __html: html\n    }\n  }), __jsx(\"div\", {\n    className: styles.actions\n  }, __jsx(\"div\", {\n    className: myLike ? styles.actions_item_active : styles.actions_item,\n    onClick: handleLike\n  }, __jsx(\"i\", {\n    className: \"iconfont icon-tubiaozhizuo-\"\n  }), num_likes ? __jsx(\"span\", {\n    className: styles.number\n  }, num_likes) : ''), __jsx(\"div\", {\n    className: myCollect ? styles.actions_item_active : styles.actions_item,\n    onClick: handleCollect\n  }, __jsx(\"i\", {\n    className: \"iconfont icon-star\"\n  }), num_collects ? __jsx(\"span\", {\n    className: styles.number\n  }, num_collects) : ''), __jsx(ReactScroll.Link, {\n    spy: true,\n    smooth: true,\n    to: \"article-comments\"\n  }, __jsx(\"div\", {\n    className: styles.actions_item\n  }, __jsx(\"i\", {\n    className: \"iconfont icon-message_three_points\"\n  }), num_comments ? __jsx(\"span\", {\n    className: styles.number\n  }, num_comments) : null)))), __jsx(\"div\", {\n    className: styles.left_content,\n    id: \"article-comments\"\n  }, __jsx(Comments, {\n    type: \"article\",\n    id: articleObj,\n    userinfo: userinfo\n  }))), __jsx(\"div\", {\n    className: styles.right\n  }, profile && profile.ads && __jsx(Ad, {\n    item: profile.ads[2]\n  }), __jsx(CategoryList, {\n    nav: nav\n  }))));\n}\n\nexport default MyComponent;","map":null,"metadata":{},"sourceType":"module"}